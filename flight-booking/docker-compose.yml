version: '3.8'

services:
  # --- Primary Database ---
  db_primary:
    image: postgres:16
    container_name: db_primary
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: flight_booking
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    volumes:
      - ./db/init:/docker-entrypoint-initdb.d
      - db_primary_data:/var/lib/postgresql/data
      - wal_archive_data:/var/lib/postgresql/wal_archive
    command: >
      -c wal_level=logical
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c archive_mode=on
      -c archive_command='test ! -f /var/lib/postgresql/wal_archive/%f && cp %p /var/lib/postgresql/wal_archive/%f'
      -c archive_timeout=3600

  # --- Hot Backup (Standby) ---
  db_hot_backup:
    image: postgres:16
    container_name: db_hot_backup
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: flight_booking
      POSTGRES_HOST_AUTH_METHOD: trust
    depends_on:
      - db_primary
    volumes:
      - db_hot_backup_data:/var/lib/postgresql/data
      - wal_archive_data:/var/lib/postgresql/wal_archive

  # --- Backend API Service ---
  backend:
    build: ./backend
    container_name: backend
    depends_on:
      - db_primary
      - db_reports
    ports:
      - "3000:3000"
    environment:
      # Primary Connection
      DB_HOST: db_primary
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: flight_booking
      DB_REPORTS_HOST: db_reports
      DB_REPORTS_PORT: 5432

  # --- Reports Database ---
  db_reports:
      image: postgres:16
      container_name: db_reports
      environment:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: flight_reports
        POSTGRES_HOST_AUTH_METHOD: trust
      depends_on:
        - db_primary
      ports:
        - "5433:5432"
      volumes:
        - db_reports_data:/var/lib/postgresql/data
        - ./db/reports:/docker-entrypoint-initdb.d

volumes:
  db_primary_data:
  db_hot_backup_data:
  db_reports_data:
  wal_archive_data: # Define the volume here